2025-11-08 10:23:19 | INFO     | uvicorn.server:serve:76 | Started server process [57559]
2025-11-08 10:23:19 | INFO     | uvicorn.lifespan.on:startup:46 | Waiting for application startup.
2025-11-08 10:23:19 | INFO     | main:lifespan:32 | üîÑ Iniciando Telegram Finance Bot...
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("transactions")
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("ai_prompt_cache")
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("user_config")
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:23:19 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:23:19 | INFO     | main:lifespan:35 | ‚úÖ Database inicializado
2025-11-08 10:23:19 | INFO     | bot.telegram_bot:_setup_handlers:65 | ‚úÖ Handlers configurados
2025-11-08 10:23:21 | INFO     | services.sheets_service:setup:36 | ‚úÖ Google Sheets configurado com sucesso
2025-11-08 10:23:21 | INFO     | services.sheets_service:ensure_sheet_structure:70 | ‚úÖ Estrutura de abas verificada - todas existem
2025-11-08 10:23:22 | INFO     | services.sheets_service:ensure_sheet_structure:75 | üîÑ Sincroniza√ß√£o necess√°ria - iniciando...
2025-11-08 10:23:22 | INFO     | services.sheets_service:_initial_sync_from_database:299 | üîÑ Iniciando sincroniza√ß√£o inicial do banco para planilha...
2025-11-08 10:23:22 | INFO     | services.sheets_service:_clean_inconsistent_data:439 | üßπ Iniciando limpeza de dados inconsistentes...
2025-11-08 10:23:22 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:23:22 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id 
FROM transactions 
WHERE transactions.status = ?
2025-11-08 10:23:22 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00089s] ('processed',)
2025-11-08 10:23:22 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:23:22 | INFO     | services.sheets_service:_clean_inconsistent_data:448 | üìä IDs v√°lidos no banco: 31
2025-11-08 10:23:24 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Abril: Nenhum dado inconsistente encontrado
2025-11-08 10:23:25 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Maio: Nenhum dado inconsistente encontrado
2025-11-08 10:23:28 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Agosto: Nenhum dado inconsistente encontrado
2025-11-08 10:23:29 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Outubro: Nenhum dado inconsistente encontrado
2025-11-08 10:23:30 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Novembro: Nenhum dado inconsistente encontrado
2025-11-08 10:23:31 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Dezembro: Nenhum dado inconsistente encontrado
2025-11-08 10:23:31 | INFO     | services.sheets_service:_clean_inconsistent_data:498 | ‚úÖ Nenhum dado inconsistente encontrado na planilha
2025-11-08 10:23:31 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:23:31 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id, transactions.original_message, transactions.user_id, transactions.message_id, transactions.chat_id, transactions.descricao, transactions.valor, transactions.categoria, transactions.data_transacao, transactions.confianca, transactions.status, transactions.error_message, transactions.sheets_row_number, transactions.sheets_updated_at, transactions.created_at, transactions.updated_at 
FROM transactions 
WHERE transactions.status = ? ORDER BY transactions.data_transacao ASC
2025-11-08 10:23:31 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00078s] ('processed',)
2025-11-08 10:23:31 | INFO     | services.sheets_service:_initial_sync_from_database:316 | üìä Encontradas 31 transa√ß√µes para sincronizar
2025-11-08 10:23:31 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Abril (1/6): 1 transa√ß√µes
2025-11-08 10:23:31 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Abril j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:23:32 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Maio (2/6): 1 transa√ß√µes
2025-11-08 10:23:32 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Maio j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:23:33 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Agosto (3/6): 2 transa√ß√µes
2025-11-08 10:23:33 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Agosto j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:23:34 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Outubro (4/6): 17 transa√ß√µes
2025-11-08 10:23:34 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Outubro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:23:35 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Novembro (5/6): 9 transa√ß√µes
2025-11-08 10:23:35 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Novembro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:23:36 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Dezembro (6/6): 1 transa√ß√µes
2025-11-08 10:23:36 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Dezembro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:23:37 | INFO     | services.sheets_service:_initial_sync_from_database:354 | ‚úÖ Sincroniza√ß√£o inicial conclu√≠da: 0 transa√ß√µes sincronizadas
2025-11-08 10:23:37 | INFO     | services.sheets_service:_mark_transactions_as_synced:426 | ‚úÖ 31 transa√ß√µes marcadas como sincronizadas no banco
2025-11-08 10:23:45 | WARNING  | services.sheets_service:_update_summary:255 | Erro ao processar m√™s Dezembro: {'code': 429, 'message': "Quota exceeded for quota metric 'Read requests' and limit 'Read requests per minute per user' of service 'sheets.googleapis.com' for consumer 'project_number:79508683601'.", 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.ErrorInfo', 'reason': 'RATE_LIMIT_EXCEEDED', 'domain': 'googleapis.com', 'metadata': {'quota_location': 'global', 'consumer': 'projects/79508683601', 'quota_unit': '1/min/{project}/{user}', 'quota_limit': 'ReadRequestsPerMinutePerUser', 'service': 'sheets.googleapis.com', 'quota_limit_value': '60', 'quota_metric': 'sheets.googleapis.com/read_requests'}}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Request a higher quota limit.', 'url': 'https://cloud.google.com/docs/quotas/help/request_increase'}]}]}
2025-11-08 10:23:45 | INFO     | services.sheets_service:_update_summary:258 | ‚úÖ Resumo atualizado
2025-11-08 10:23:45 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:23:46 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/setWebhook "HTTP/1.1 200 OK"
2025-11-08 10:23:46 | INFO     | bot.telegram_bot:_setup_webhook:71 | ‚úÖ Webhook configurado: https://lillyana-cordis-underhandedly.ngrok-free.dev/webhook
2025-11-08 10:23:46 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/getMe "HTTP/1.1 200 OK"
2025-11-08 10:23:46 | INFO     | bot.telegram_bot:setup:44 | ‚úÖ Bot do Telegram configurado com sucesso
2025-11-08 10:23:46 | INFO     | main:lifespan:39 | ‚úÖ Bot configurado com sucesso
2025-11-08 10:23:46 | INFO     | uvicorn.lifespan.on:startup:60 | Application startup complete.
2025-11-08 10:24:30 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625398
2025-11-08 10:24:30 | INFO     | bot.telegram_bot:handle_expense_message:623 | üîÑ Processando mensagem: '10 reais almo√ßo hoje...'
2025-11-08 10:24:31 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendChatAction "HTTP/1.1 200 OK"
2025-11-08 10:24:31 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:31 | INFO     | sqlalchemy.log:log:210 | SELECT ai_prompt_cache.id, ai_prompt_cache.input_hash, ai_prompt_cache.input_text, ai_prompt_cache.output_json, ai_prompt_cache.model_used, ai_prompt_cache.created_at, ai_prompt_cache.expires_at 
FROM ai_prompt_cache 
WHERE ai_prompt_cache.input_hash = ? AND ai_prompt_cache.expires_at > ?
2025-11-08 10:24:31 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00076s] ('a4762ec042902c038f5359c672a5c478546fb10b0756fa199378465467d31753', '2025-11-08 10:24:31.540200')
2025-11-08 10:24:31 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:24:31 | INFO     | services.openai_service:interpret_financial_message:39 | üß† Processando mensagem com gpt-4o-mini
2025-11-08 10:24:34 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-11-08 10:24:34 | INFO     | services.openai_service:interpret_financial_message:57 | Resposta da IA recebida: 110 caracteres
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | INSERT INTO ai_prompt_cache (input_hash, input_text, output_json, model_used, created_at, expires_at) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, ?) RETURNING id, created_at
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00063s] ('a4762ec042902c038f5359c672a5c478546fb10b0756fa199378465467d31753', '10 reais almo√ßo hoje', '```json\n{"descricao":"Almo√ßo","valor":10.00,"categoria":"Alimenta√ß√£o","data":"2025-11-08","confianca":0.9}\n```', 'gpt-4o-mini', '2025-11-15 10:24:34.301838')
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | INSERT INTO transactions (original_message, user_id, message_id, chat_id, descricao, valor, categoria, data_transacao, confianca, status, error_message, sheets_row_number, sheets_updated_at, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) RETURNING id, created_at, updated_at
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00036s] ('10 reais almo√ßo hoje', 672834537, 370, 672834537, 'Almo√ßo', 10.0, 'Alimenta√ß√£o', '2025-11-08', 0.9, 'processed', None, None, None)
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id, transactions.original_message, transactions.user_id, transactions.message_id, transactions.chat_id, transactions.descricao, transactions.valor, transactions.categoria, transactions.data_transacao, transactions.confianca, transactions.status, transactions.error_message, transactions.sheets_row_number, transactions.sheets_updated_at, transactions.created_at, transactions.updated_at 
FROM transactions 
WHERE transactions.id = ?
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00022s] (32,)
2025-11-08 10:24:34 | ERROR    | services.sheets_service:add_transaction:176 | ‚ùå Erro ao adicionar transa√ß√£o: {'code': 429, 'message': "Quota exceeded for quota metric 'Read requests' and limit 'Read requests per minute per user' of service 'sheets.googleapis.com' for consumer 'project_number:79508683601'.", 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.ErrorInfo', 'reason': 'RATE_LIMIT_EXCEEDED', 'domain': 'googleapis.com', 'metadata': {'consumer': 'projects/79508683601', 'quota_location': 'global', 'service': 'sheets.googleapis.com', 'quota_limit': 'ReadRequestsPerMinutePerUser', 'quota_unit': '1/min/{project}/{user}', 'quota_metric': 'sheets.googleapis.com/read_requests', 'quota_limit_value': '60'}}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Request a higher quota limit.', 'url': 'https://cloud.google.com/docs/quotas/help/request_increase'}]}]}
2025-11-08 10:24:34 | ERROR    | bot.telegram_bot:handle_expense_message:643 | ‚ùå Erro ao processar mensagem: {'code': 429, 'message': "Quota exceeded for quota metric 'Read requests' and limit 'Read requests per minute per user' of service 'sheets.googleapis.com' for consumer 'project_number:79508683601'.", 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.ErrorInfo', 'reason': 'RATE_LIMIT_EXCEEDED', 'domain': 'googleapis.com', 'metadata': {'consumer': 'projects/79508683601', 'quota_location': 'global', 'service': 'sheets.googleapis.com', 'quota_limit': 'ReadRequestsPerMinutePerUser', 'quota_unit': '1/min/{project}/{user}', 'quota_metric': 'sheets.googleapis.com/read_requests', 'quota_limit_value': '60'}}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Request a higher quota limit.', 'url': 'https://cloud.google.com/docs/quotas/help/request_increase'}]}]}
2025-11-08 10:24:34 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:24:34 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:24:34 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:24:49 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625399
2025-11-08 10:24:49 | INFO     | bot.telegram_bot:handle_expense_message:623 | üîÑ Processando mensagem: '50 reais almo√ßo hoje...'
2025-11-08 10:24:50 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendChatAction "HTTP/1.1 200 OK"
2025-11-08 10:24:50 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:50 | INFO     | sqlalchemy.log:log:210 | SELECT ai_prompt_cache.id, ai_prompt_cache.input_hash, ai_prompt_cache.input_text, ai_prompt_cache.output_json, ai_prompt_cache.model_used, ai_prompt_cache.created_at, ai_prompt_cache.expires_at 
FROM ai_prompt_cache 
WHERE ai_prompt_cache.input_hash = ? AND ai_prompt_cache.expires_at > ?
2025-11-08 10:24:50 | INFO     | sqlalchemy.log:log:210 | [cached since 18.54s ago] ('85317c30611fa3373a2db8415cb952431bde49499f74470248f5acf5b6f70183', '2025-11-08 10:24:50.090230')
2025-11-08 10:24:50 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:24:50 | INFO     | services.openai_service:interpret_financial_message:39 | üß† Processando mensagem com gpt-4o-mini
2025-11-08 10:24:53 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-11-08 10:24:53 | INFO     | services.openai_service:interpret_financial_message:57 | Resposta da IA recebida: 110 caracteres
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | INSERT INTO ai_prompt_cache (input_hash, input_text, output_json, model_used, created_at, expires_at) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, ?) RETURNING id, created_at
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | [cached since 18.83s ago] ('85317c30611fa3373a2db8415cb952431bde49499f74470248f5acf5b6f70183', '50 reais almo√ßo hoje', '```json\n{"descricao":"Almo√ßo","valor":50.00,"categoria":"Alimenta√ß√£o","data":"2025-11-08","confianca":0.9}\n```', 'gpt-4o-mini', '2025-11-15 10:24:53.140127')
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | INSERT INTO transactions (original_message, user_id, message_id, chat_id, descricao, valor, categoria, data_transacao, confianca, status, error_message, sheets_row_number, sheets_updated_at, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) RETURNING id, created_at, updated_at
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | [cached since 18.82s ago] ('50 reais almo√ßo hoje', 672834537, 372, 672834537, 'Almo√ßo', 50.0, 'Alimenta√ß√£o', '2025-11-08', 0.9, 'processed', None, None, None)
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id, transactions.original_message, transactions.user_id, transactions.message_id, transactions.chat_id, transactions.descricao, transactions.valor, transactions.categoria, transactions.data_transacao, transactions.confianca, transactions.status, transactions.error_message, transactions.sheets_row_number, transactions.sheets_updated_at, transactions.created_at, transactions.updated_at 
FROM transactions 
WHERE transactions.id = ?
2025-11-08 10:24:53 | INFO     | sqlalchemy.log:log:210 | [cached since 18.82s ago] (33,)
2025-11-08 10:24:53 | INFO     | services.sheets_service:add_transaction:147 | üîç Verificando se transa√ß√£o ID 33 j√° existe na aba Novembro
2025-11-08 10:24:53 | WARNING  | services.sheets_service:_find_transaction_by_id:194 | ‚ö†Ô∏è Erro ao procurar transa√ß√£o por ID: {'code': 429, 'message': "Quota exceeded for quota metric 'Read requests' and limit 'Read requests per minute per user' of service 'sheets.googleapis.com' for consumer 'project_number:79508683601'.", 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.ErrorInfo', 'reason': 'RATE_LIMIT_EXCEEDED', 'domain': 'googleapis.com', 'metadata': {'quota_location': 'global', 'consumer': 'projects/79508683601', 'quota_unit': '1/min/{project}/{user}', 'quota_limit': 'ReadRequestsPerMinutePerUser', 'service': 'sheets.googleapis.com', 'quota_limit_value': '60', 'quota_metric': 'sheets.googleapis.com/read_requests'}}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Request a higher quota limit.', 'url': 'https://cloud.google.com/docs/quotas/help/request_increase'}]}]}
2025-11-08 10:24:53 | INFO     | services.sheets_service:add_transaction:153 | ‚úÖ Transa√ß√£o ID 33 n√£o existe, adicionando...
2025-11-08 10:24:53 | INFO     | services.sheets_service:add_transaction:164 | üìù Adicionando transa√ß√£o √† aba Novembro: [33, '08/11/2025', 'Almo√ßo', 'Alimenta√ß√£o', 50.0, 'Confian√ßa: 90.0%']
2025-11-08 10:25:03 | INFO     | services.sheets_service:_update_summary:258 | ‚úÖ Resumo atualizado
2025-11-08 10:25:03 | INFO     | services.sheets_service:add_transaction:172 | ‚úÖ Transa√ß√£o adicionada na aba Novembro, linha 10
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id AS transactions_id, transactions.original_message AS transactions_original_message, transactions.user_id AS transactions_user_id, transactions.message_id AS transactions_message_id, transactions.chat_id AS transactions_chat_id, transactions.descricao AS transactions_descricao, transactions.valor AS transactions_valor, transactions.categoria AS transactions_categoria, transactions.data_transacao AS transactions_data_transacao, transactions.confianca AS transactions_confianca, transactions.status AS transactions_status, transactions.error_message AS transactions_error_message, transactions.sheets_row_number AS transactions_sheets_row_number, transactions.sheets_updated_at AS transactions_sheets_updated_at, transactions.created_at AS transactions_created_at, transactions.updated_at AS transactions_updated_at 
FROM transactions 
WHERE transactions.id = ?
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00030s] (33,)
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | UPDATE transactions SET sheets_row_number=?, sheets_updated_at=?, updated_at=CURRENT_TIMESTAMP WHERE transactions.id = ?
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00025s] (10, '2025-11-08 10:25:03.512053', 33)
2025-11-08 10:25:03 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:25:04 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:25:04 | INFO     | bot.telegram_bot:handle_expense_message:640 | ‚úÖ Transa√ß√£o processada com sucesso: ID 33
2025-11-08 10:25:04 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:25:10 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625400
2025-11-08 10:25:11 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:25:11 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:25:41 | INFO     | uvicorn.server:shutdown:264 | Shutting down
2025-11-08 10:25:41 | INFO     | uvicorn.lifespan.on:shutdown:65 | Waiting for application shutdown.
2025-11-08 10:25:41 | ERROR    | uvicorn.lifespan.on:send:134 | Traceback (most recent call last):
  File "/Users/lazarim/workspace/freelancer/telegram-finbot/.venv/lib/python3.9/site-packages/starlette/routing.py", line 686, in lifespan
    await receive()
  File "/Users/lazarim/.pyenv/versions/3.9.23/lib/python3.9/contextlib.py", line 188, in __aexit__
    await self.gen.__anext__()
  File "/Users/lazarim/workspace/freelancer/telegram-finnbot/main.py", line 48, in lifespan
    await bot_instance.stop()
  File "/Users/lazarim/workspace/freelancer/telegram-finnbot/bot/telegram_bot.py", line 751, in stop
    await self.application.stop()
  File "/Users/lazarim/workspace/freelancer/telegram-finbot/.venv/lib/python3.9/site-packages/telegram/ext/_application.py", line 663, in stop
    raise RuntimeError("This Application is not running!")
RuntimeError: This Application is not running!

2025-11-08 10:25:41 | ERROR    | uvicorn.lifespan.on:shutdown:73 | Application shutdown failed. Exiting.
2025-11-08 10:25:41 | INFO     | uvicorn.server:serve:86 | Finished server process [57559]
2025-11-08 10:25:42 | INFO     | uvicorn.server:serve:76 | Started server process [57631]
2025-11-08 10:25:42 | INFO     | uvicorn.lifespan.on:startup:46 | Waiting for application startup.
2025-11-08 10:25:42 | INFO     | main:lifespan:32 | üîÑ Iniciando Telegram Finance Bot...
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("transactions")
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("ai_prompt_cache")
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("user_config")
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:25:42 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:25:42 | INFO     | main:lifespan:35 | ‚úÖ Database inicializado
2025-11-08 10:25:42 | INFO     | bot.telegram_bot:_setup_handlers:65 | ‚úÖ Handlers configurados
2025-11-08 10:25:42 | INFO     | services.sheets_service:setup:36 | ‚úÖ Google Sheets configurado com sucesso
2025-11-08 10:25:43 | INFO     | services.sheets_service:ensure_sheet_structure:70 | ‚úÖ Estrutura de abas verificada - todas existem
2025-11-08 10:25:43 | INFO     | services.sheets_service:ensure_sheet_structure:75 | üîÑ Sincroniza√ß√£o necess√°ria - iniciando...
2025-11-08 10:25:43 | INFO     | services.sheets_service:_initial_sync_from_database:299 | üîÑ Iniciando sincroniza√ß√£o inicial do banco para planilha...
2025-11-08 10:25:43 | INFO     | services.sheets_service:_clean_inconsistent_data:439 | üßπ Iniciando limpeza de dados inconsistentes...
2025-11-08 10:25:43 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:25:43 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id 
FROM transactions 
WHERE transactions.status = ?
2025-11-08 10:25:43 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00019s] ('processed',)
2025-11-08 10:25:43 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:25:43 | INFO     | services.sheets_service:_clean_inconsistent_data:448 | üìä IDs v√°lidos no banco: 33
2025-11-08 10:25:46 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Abril: Nenhum dado inconsistente encontrado
2025-11-08 10:25:47 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Maio: Nenhum dado inconsistente encontrado
2025-11-08 10:25:49 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Agosto: Nenhum dado inconsistente encontrado
2025-11-08 10:25:51 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Outubro: Nenhum dado inconsistente encontrado
2025-11-08 10:25:52 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Novembro: Nenhum dado inconsistente encontrado
2025-11-08 10:25:52 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Dezembro: Nenhum dado inconsistente encontrado
2025-11-08 10:25:52 | INFO     | services.sheets_service:_clean_inconsistent_data:498 | ‚úÖ Nenhum dado inconsistente encontrado na planilha
2025-11-08 10:25:52 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:25:52 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id, transactions.original_message, transactions.user_id, transactions.message_id, transactions.chat_id, transactions.descricao, transactions.valor, transactions.categoria, transactions.data_transacao, transactions.confianca, transactions.status, transactions.error_message, transactions.sheets_row_number, transactions.sheets_updated_at, transactions.created_at, transactions.updated_at 
FROM transactions 
WHERE transactions.status = ? ORDER BY transactions.data_transacao ASC
2025-11-08 10:25:52 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00076s] ('processed',)
2025-11-08 10:25:52 | INFO     | services.sheets_service:_initial_sync_from_database:316 | üìä Encontradas 33 transa√ß√µes para sincronizar
2025-11-08 10:25:52 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Abril (1/6): 1 transa√ß√µes
2025-11-08 10:25:53 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Abril j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:25:53 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Maio (2/6): 1 transa√ß√µes
2025-11-08 10:25:54 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Maio j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:25:54 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Agosto (3/6): 2 transa√ß√µes
2025-11-08 10:25:55 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Agosto j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:25:55 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Outubro (4/6): 17 transa√ß√µes
2025-11-08 10:25:56 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Outubro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:25:56 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Novembro (5/6): 11 transa√ß√µes
2025-11-08 10:25:57 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Novembro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:25:57 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Dezembro (6/6): 1 transa√ß√µes
2025-11-08 10:25:58 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Dezembro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:25:58 | INFO     | services.sheets_service:_initial_sync_from_database:354 | ‚úÖ Sincroniza√ß√£o inicial conclu√≠da: 0 transa√ß√µes sincronizadas
2025-11-08 10:25:58 | INFO     | services.sheets_service:_mark_transactions_as_synced:426 | ‚úÖ 33 transa√ß√µes marcadas como sincronizadas no banco
2025-11-08 10:26:06 | INFO     | services.sheets_service:_update_summary:258 | ‚úÖ Resumo atualizado
2025-11-08 10:26:06 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:26:07 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/setWebhook "HTTP/1.1 200 OK"
2025-11-08 10:26:07 | INFO     | bot.telegram_bot:_setup_webhook:71 | ‚úÖ Webhook configurado: https://lillyana-cordis-underhandedly.ngrok-free.dev/webhook
2025-11-08 10:26:07 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/getMe "HTTP/1.1 200 OK"
2025-11-08 10:26:07 | INFO     | bot.telegram_bot:setup:44 | ‚úÖ Bot do Telegram configurado com sucesso
2025-11-08 10:26:07 | INFO     | main:lifespan:39 | ‚úÖ Bot configurado com sucesso
2025-11-08 10:26:07 | INFO     | uvicorn.lifespan.on:startup:60 | Application startup complete.
2025-11-08 10:26:13 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625401
2025-11-08 10:26:14 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:26:14 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:26:24 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625402
2025-11-08 10:26:25 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:26:25 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:26:25 | INFO     | sqlalchemy.log:log:210 | SELECT user_config.id, user_config.user_id, user_config.spreadsheet_id, user_config.timezone, user_config.default_currency, user_config.auto_categorize, user_config.send_daily_summary, user_config.send_monthly_insights, user_config.created_at, user_config.updated_at 
FROM user_config 
WHERE user_config.user_id = ?
2025-11-08 10:26:25 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00066s] (672834537,)
2025-11-08 10:26:25 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:26:25 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:26:41 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625403
2025-11-08 10:26:42 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:26:42 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:26:52 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625404
2025-11-08 10:26:52 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendChatAction "HTTP/1.1 200 OK"
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | SELECT count(transactions.id) AS count_1 
FROM transactions 
WHERE transactions.status = ?
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00062s] ('processed',)
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | SELECT min(transactions.data_transacao) AS primeira, max(transactions.data_transacao) AS ultima 
FROM transactions 
WHERE transactions.status = ?
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00053s] ('processed',)
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | SELECT sum(transactions.valor) AS sum_1 
FROM transactions 
WHERE transactions.status = ? AND transactions.categoria != ?
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00054s] ('processed', 'Finan√ßas')
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.categoria, sum(transactions.valor) AS total, count(transactions.id) AS transacoes, avg(transactions.valor) AS media, max(transactions.valor) AS maior, min(transactions.valor) AS menor 
FROM transactions 
WHERE CAST(STRFTIME('%Y', transactions.data_transacao) AS INTEGER) = ? AND transactions.status = ? GROUP BY transactions.categoria ORDER BY sum(transactions.valor) DESC
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00028s] (2025, 'processed')
2025-11-08 10:26:52 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:26:53 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:26:53 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:27:14 | INFO     | uvicorn.server:shutdown:264 | Shutting down
2025-11-08 10:27:14 | INFO     | uvicorn.lifespan.on:shutdown:65 | Waiting for application shutdown.
2025-11-08 10:27:14 | ERROR    | uvicorn.lifespan.on:send:134 | Traceback (most recent call last):
  File "/Users/lazarim/workspace/freelancer/telegram-finbot/.venv/lib/python3.9/site-packages/starlette/routing.py", line 686, in lifespan
    await receive()
  File "/Users/lazarim/.pyenv/versions/3.9.23/lib/python3.9/contextlib.py", line 188, in __aexit__
    await self.gen.__anext__()
  File "/Users/lazarim/workspace/freelancer/telegram-finnbot/main.py", line 48, in lifespan
    await bot_instance.stop()
  File "/Users/lazarim/workspace/freelancer/telegram-finnbot/bot/telegram_bot.py", line 751, in stop
    await self.application.stop()
  File "/Users/lazarim/workspace/freelancer/telegram-finbot/.venv/lib/python3.9/site-packages/telegram/ext/_application.py", line 663, in stop
    raise RuntimeError("This Application is not running!")
RuntimeError: This Application is not running!

2025-11-08 10:27:14 | ERROR    | uvicorn.lifespan.on:shutdown:73 | Application shutdown failed. Exiting.
2025-11-08 10:27:14 | INFO     | uvicorn.server:serve:86 | Finished server process [57631]
2025-11-08 10:27:15 | INFO     | uvicorn.server:serve:76 | Started server process [57666]
2025-11-08 10:27:15 | INFO     | uvicorn.lifespan.on:startup:46 | Waiting for application startup.
2025-11-08 10:27:15 | INFO     | main:lifespan:32 | üîÑ Iniciando Telegram Finance Bot...
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("transactions")
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("ai_prompt_cache")
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | PRAGMA main.table_info("user_config")
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | [raw sql] ()
2025-11-08 10:27:15 | INFO     | sqlalchemy.log:log:210 | COMMIT
2025-11-08 10:27:15 | INFO     | main:lifespan:35 | ‚úÖ Database inicializado
2025-11-08 10:27:15 | INFO     | bot.telegram_bot:_setup_handlers:65 | ‚úÖ Handlers configurados
2025-11-08 10:27:16 | INFO     | services.sheets_service:setup:36 | ‚úÖ Google Sheets configurado com sucesso
2025-11-08 10:27:17 | INFO     | services.sheets_service:ensure_sheet_structure:70 | ‚úÖ Estrutura de abas verificada - todas existem
2025-11-08 10:27:17 | INFO     | services.sheets_service:ensure_sheet_structure:75 | üîÑ Sincroniza√ß√£o necess√°ria - iniciando...
2025-11-08 10:27:17 | INFO     | services.sheets_service:_initial_sync_from_database:299 | üîÑ Iniciando sincroniza√ß√£o inicial do banco para planilha...
2025-11-08 10:27:17 | INFO     | services.sheets_service:_clean_inconsistent_data:439 | üßπ Iniciando limpeza de dados inconsistentes...
2025-11-08 10:27:17 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:27:17 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id 
FROM transactions 
WHERE transactions.status = ?
2025-11-08 10:27:17 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00040s] ('processed',)
2025-11-08 10:27:17 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:27:17 | INFO     | services.sheets_service:_clean_inconsistent_data:448 | üìä IDs v√°lidos no banco: 33
2025-11-08 10:27:20 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Abril: Nenhum dado inconsistente encontrado
2025-11-08 10:27:21 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Maio: Nenhum dado inconsistente encontrado
2025-11-08 10:27:23 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Agosto: Nenhum dado inconsistente encontrado
2025-11-08 10:27:25 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Outubro: Nenhum dado inconsistente encontrado
2025-11-08 10:27:26 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Novembro: Nenhum dado inconsistente encontrado
2025-11-08 10:27:26 | INFO     | services.sheets_service:_clean_inconsistent_data:489 | ‚úÖ Dezembro: Nenhum dado inconsistente encontrado
2025-11-08 10:27:26 | INFO     | services.sheets_service:_clean_inconsistent_data:498 | ‚úÖ Nenhum dado inconsistente encontrado na planilha
2025-11-08 10:27:26 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:27:26 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id, transactions.original_message, transactions.user_id, transactions.message_id, transactions.chat_id, transactions.descricao, transactions.valor, transactions.categoria, transactions.data_transacao, transactions.confianca, transactions.status, transactions.error_message, transactions.sheets_row_number, transactions.sheets_updated_at, transactions.created_at, transactions.updated_at 
FROM transactions 
WHERE transactions.status = ? ORDER BY transactions.data_transacao ASC
2025-11-08 10:27:26 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00167s] ('processed',)
2025-11-08 10:27:26 | INFO     | services.sheets_service:_initial_sync_from_database:316 | üìä Encontradas 33 transa√ß√µes para sincronizar
2025-11-08 10:27:26 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Abril (1/6): 1 transa√ß√µes
2025-11-08 10:27:27 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Abril j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:27:27 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Maio (2/6): 1 transa√ß√µes
2025-11-08 10:27:28 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Maio j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:27:28 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Agosto (3/6): 2 transa√ß√µes
2025-11-08 10:27:29 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Agosto j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:27:29 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Outubro (4/6): 17 transa√ß√µes
2025-11-08 10:27:30 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Outubro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:27:30 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Novembro (5/6): 11 transa√ß√µes
2025-11-08 10:27:31 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Novembro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:27:31 | INFO     | services.sheets_service:_initial_sync_from_database:347 | üìÖ Sincronizando Dezembro (6/6): 1 transa√ß√µes
2025-11-08 10:27:32 | INFO     | services.sheets_service:_batch_insert_transactions:370 | ‚ö†Ô∏è Aba Dezembro j√° cont√©m dados - pulando sincroniza√ß√£o
2025-11-08 10:27:32 | INFO     | services.sheets_service:_initial_sync_from_database:354 | ‚úÖ Sincroniza√ß√£o inicial conclu√≠da: 0 transa√ß√µes sincronizadas
2025-11-08 10:27:32 | INFO     | services.sheets_service:_mark_transactions_as_synced:426 | ‚úÖ 33 transa√ß√µes marcadas como sincronizadas no banco
2025-11-08 10:27:41 | INFO     | services.sheets_service:_update_summary:258 | ‚úÖ Resumo atualizado
2025-11-08 10:27:41 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:27:41 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/setWebhook "HTTP/1.1 200 OK"
2025-11-08 10:27:41 | INFO     | bot.telegram_bot:_setup_webhook:71 | ‚úÖ Webhook configurado: https://lillyana-cordis-underhandedly.ngrok-free.dev/webhook
2025-11-08 10:27:41 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/getMe "HTTP/1.1 200 OK"
2025-11-08 10:27:41 | INFO     | bot.telegram_bot:setup:44 | ‚úÖ Bot do Telegram configurado com sucesso
2025-11-08 10:27:41 | INFO     | main:lifespan:39 | ‚úÖ Bot configurado com sucesso
2025-11-08 10:27:41 | INFO     | uvicorn.lifespan.on:startup:60 | Application startup complete.
2025-11-08 10:28:27 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625405
2025-11-08 10:28:28 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:28:28 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:28:36 | INFO     | main:telegram_webhook:89 | Received webhook update: 415625406
2025-11-08 10:28:37 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendChatAction "HTTP/1.1 200 OK"
2025-11-08 10:28:37 | INFO     | sqlalchemy.log:log:210 | BEGIN (implicit)
2025-11-08 10:28:37 | INFO     | sqlalchemy.log:log:210 | SELECT transactions.id, transactions.original_message, transactions.user_id, transactions.message_id, transactions.chat_id, transactions.descricao, transactions.valor, transactions.categoria, transactions.data_transacao, transactions.confianca, transactions.status, transactions.error_message, transactions.sheets_row_number, transactions.sheets_updated_at, transactions.created_at, transactions.updated_at 
FROM transactions 
WHERE CAST(STRFTIME('%m', transactions.data_transacao) AS INTEGER) = ? AND CAST(STRFTIME('%Y', transactions.data_transacao) AS INTEGER) = ? AND transactions.status = ? ORDER BY transactions.data_transacao DESC
2025-11-08 10:28:37 | INFO     | sqlalchemy.log:log:210 | [generated in 0.00110s] (11, 2025, 'processed')
2025-11-08 10:28:37 | INFO     | services.openai_service:generate_financial_insights:199 | üß† Gerando insights financeiros para November 2025
2025-11-08 10:28:37 | INFO     | sqlalchemy.log:log:210 | ROLLBACK
2025-11-08 10:28:48 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-11-08 10:28:48 | INFO     | services.openai_service:generate_financial_insights:220 | ‚úÖ Insights gerados: 1974 caracteres
2025-11-08 10:28:49 | INFO     | httpx._client:_send_single_request:1773 | HTTP Request: POST https://api.telegram.org/bot8230302035:AAF2jaUvu_7Q17HeFYBlntT0CTAxHb6W9pA/sendMessage "HTTP/1.1 200 OK"
2025-11-08 10:28:49 | INFO     | uvicorn.protocols.http.httptools_impl:send:496 | 91.108.5.5:0 - "POST /webhook HTTP/1.1" 200
2025-11-08 10:29:53 | INFO     | uvicorn.server:shutdown:264 | Shutting down
2025-11-08 10:29:53 | INFO     | uvicorn.lifespan.on:shutdown:65 | Waiting for application shutdown.
2025-11-08 10:29:53 | ERROR    | uvicorn.lifespan.on:send:134 | Traceback (most recent call last):
  File "/Users/lazarim/workspace/freelancer/telegram-finbot/.venv/lib/python3.9/site-packages/starlette/routing.py", line 686, in lifespan
    await receive()
  File "/Users/lazarim/.pyenv/versions/3.9.23/lib/python3.9/contextlib.py", line 188, in __aexit__
    await self.gen.__anext__()
  File "/Users/lazarim/workspace/freelancer/telegram-finnbot/main.py", line 48, in lifespan
    await bot_instance.stop()
  File "/Users/lazarim/workspace/freelancer/telegram-finnbot/bot/telegram_bot.py", line 751, in stop
    await self.application.stop()
  File "/Users/lazarim/workspace/freelancer/telegram-finbot/.venv/lib/python3.9/site-packages/telegram/ext/_application.py", line 663, in stop
    raise RuntimeError("This Application is not running!")
RuntimeError: This Application is not running!

2025-11-08 10:29:53 | ERROR    | uvicorn.lifespan.on:shutdown:73 | Application shutdown failed. Exiting.
2025-11-08 10:29:53 | INFO     | uvicorn.server:serve:86 | Finished server process [57666]
